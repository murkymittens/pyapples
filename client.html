<!DOCTYPE html>
<html>
   <head>
   </head>
   <body>
      <h1>Autobahn WebSocket Broadcast Demo</h1>
      <noscript>You must enable JavaScript</noscript>
      <form>
         <p>Broadcast Message: <input id="message" type="text" size="50" maxlength="50" value=""></p>
      </form>
      <button onclick='sendChat();'>Broadcast Message</button>
      <pre id="log" style="height: 20em; overflow-y: scroll; background-color: #faa;"></pre>

      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
      <script type="text/javascript" src="jquery.json-2.4.min.js"></script>
      <script type="text/javascript">
         var socket = null;
         var log = null;
         var messageBox = null;
         var wsurl = "ws://localhost:8888";
         var sessionId = null;

         $(function() {
            log = $("#log");
            messageBox = $("#message");
            connect(wsurl);
            if(socket) {
               socket.onopen = onConnectionOpen
               socket.onclose = onConnectionClosed
               socket.onmessage = onMessageReceived
            }
         })

         function connect(wsurl) {
            socket = new WebSocket(wsurl);
         }

         function sendMessage(msgType, msgPayload) {
            if(socket) {
               var json = {type: msgType, payload: msgPayload};
               var encoded = $.toJSON(json);
               socket.send(encoded);
            }
         }

         function sendChat() {
            message = messageBox.val();
            messageBox.val('');
            //sendMessage('1', message);
            command = message.split(" ");
            switch(command[0]) {
               case 'create_game':
                  sendMessage(3, command[1]);
                  break;
               case 'join_game':
                  sendMessage(7, command[1]);
                  break;
               case 'start_round':
                  sendMessage(14, '');
                  break;
               case 'red':
                  sendMessage(15, command[1]);
                  break;
               case 'winner':
                  sendMessage(16, command[1]);
                  break;
               case 'name':
                  sendMessage(6, command[1]);
                  break;
            }
         }

         function onMessageReceived(event) {
            var message = $.parseJSON(event.data);
            switch(message.type) {
               case 0: // system message
                  appendChat('SYSTEM', message.payload);
                  break;
               case 1: // receive session id
                  sessionId = message.payload;
                  appendChat('SYSTEM', "Got session id: " + sessionId);
                  break;
               default:
                  //appendChat('GAME', message.payload);
                  console.log("object %o", message.payload);
                  break;
            }
         }

         function onConnectionOpen() {
            appendChat('LOCAL', "Connected to server");
         }

         function onConnectionClosed(event) {
            appendChat('LOCAL', "Disconnected from server");
         }

         function appendChat(user, message) {
            log.append("<div><b>" + user + ":</b> " + message + "</div>");
            log.scrollTop(log.scrollHeight)
         }
      </script>
   </body>
</html>
