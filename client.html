<!DOCTYPE html>
<html>
   <head>
   </head>
   <body>
      <h1>Autobahn WebSocket Broadcast Demo</h1>
      <noscript>You must enable JavaScript</noscript>
      <form>
         <p>Broadcast Message: <input id="message" type="text" size="50" maxlength="50" value=""></p>
      </form>
      <button onclick='send();'>Broadcast Message</button>
      <pre id="log" style="height: 20em; overflow-y: scroll; background-color: #faa;"></pre>

      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
      <script type="text/javascript" src="jquery.json-2.4.min.js"></script>
      <script type="text/javascript">
         var socket = null;
         var log = null;
         var messageBox = null;
         var wsurl = "ws://localhost:8888";
         var sessionId = null;

         $(function() {
            log = $("#log");
            messageBox = $("#message");
            //connect(wsurl);
            socket = new WebSocket(wsurl);
            if(socket) {
               socket.onopen = onConnectionOpen
               socket.onclose = onConnectionClosed
               socket.onmessage = onMessageReceived
            }
         })

         function connect(wsurl) {
            socket = new WebSocket(wsurl);
         }

         function send() {
            message = messageBox.val();
            messageBox.val('');
            if(socket) {
               var json = {type: 1, payload: message}
               var encoded = $.toJSON(json);
               alert(encoded);
               socket.send(encoded);
            }
         }

         function onMessageReceived(event) {
            var message = $.parseJSON(event.data);
            switch(message.type) {
               case 0: // system message
                  appendChat(message.payload);
                  break;
            }
         }

         function onConnectionOpen() {
            appendChat("Connected to server");
         }

         function onConnectionClosed(event) {
            appendChat("Disconnected from server");
         }

         function appendChat(message) {
            log.append("<div>" + message + "</div>");
            log.scrollTop(log.scrollHeight)
         }
      </script>
   </body>
</html>
